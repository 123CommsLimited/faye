if(!this.Faye)Faye={};Faye.extend=function(a,c,b){if(!c)return a;for(var d in c){if(!c.hasOwnProperty(d))continue;if(a.hasOwnProperty(d)&&b===false)continue;if(a[d]!==c[d])a[d]=c[d]}return a};Faye.extend(Faye,{BAYEUX_VERSION:'1.0',VERSION:'0.3.0',JSONP_CALLBACK:'jsonpcallback',ID_LENGTH:128,CONNECTION_TYPES:["long-polling","callback-polling"],ENV:this,Grammar:{LOWALPHA:/^[a-z]$/,UPALPHA:/^[A-Z]$/,ALPHA:/^([a-z]|[A-Z])$/,DIGIT:/^[0-9]$/,ALPHANUM:/^(([a-z]|[A-Z])|[0-9])$/,MARK:/^(\-|\_|\!|\~|\(|\)|\$|\@)$/,STRING:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,TOKEN:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,INTEGER:/^([0-9])+$/,CHANNEL_SEGMENT:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,CHANNEL_SEGMENTS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,WILD_CARD:/^\*{1,2}$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,VERSION_ELEMENT:/^(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/,CLIENT_ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ERROR_MESSAGE:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,ERROR_ARGS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*$/,ERROR_CODE:/^[0-9][0-9][0-9]$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/},commonElement:function(a,c){for(var b=0,d=a.length;b<d;b++){if(this.indexOf(c,a[b])!==-1)return a[b]}return null},indexOf:function(a,c){for(var b=0,d=a.length;b<d;b++){if(a[b]===c)return b}return-1},each:function(a,c,b){if(a instanceof Array){for(var d=0,f=a.length;d<f;d++){if(a[d]!==undefined)c.call(b||null,a[d],d)}}else{for(var g in a){if(a.hasOwnProperty(g))c.call(b||null,g,a[g])}}},filter:function(a,c,b){var d=[];this.each(a,function(){if(c.apply(b,arguments))d.push(arguments[0])});return d},size:function(a){var c=0;this.each(a,function(){c+=1});return c},random:function(){var a=Math.pow(2,this.ID_LENGTH);return(Math.random()*a).toString(16).replace(/0*$/,'')},enumEqual:function(b,d){if(d instanceof Array){if(!(b instanceof Array))return false;var f=b.length;if(f!==d.length)return false;while(f--){if(b[f]!==d[f])return false}return true}else{if(!(b instanceof Object))return false;if(this.size(d)!==this.size(b))return false;var g=true;this.each(b,function(a,c){g=g&&(d[a]===c)});return g}}});Faye.Class=function(a,c){if(typeof a!=='function'){c=a;a=Object}var b=function(){if(!this.initialize)return this;return this.initialize.apply(this,arguments)||this};var d=function(){};d.prototype=a.prototype;b.prototype=new d();Faye.extend(b.prototype,c);return b};Faye.Observable={on:function(a,c,b){this._1=this._1||{};var d=this._1[a]=this._1[a]||[];d.push([c,b])},stopObserving:function(a,c,b){if(!this._1||!this._1[a])return;if(!c){delete this._1[a];return}var d=this._1[a],f=d.length;while(f--){if(c&&d[f][0]!==c)continue;if(b&&d[f][1]!==b)continue;d.splice(f,1)}},fire:function(){var c=Array.prototype.slice.call(arguments),b=c.shift();if(!this._1||!this._1[b])return;Faye.each(this._1[b],function(a){a[0].apply(a[1],c.slice())})}};Faye.Channel=Faye.Class({initialize:function(a){this.__id=this.name=a},push:function(a){this.fire('message',a)}});Faye.extend(Faye.Channel.prototype,Faye.Observable);Faye.extend(Faye.Channel,{HANDSHAKE:'/meta/handshake',CONNECT:'/meta/connect',SUBSCRIBE:'/meta/subscribe',UNSUBSCRIBE:'/meta/unsubscribe',DISCONNECT:'/meta/disconnect',META:'meta',SERVICE:'service',isValid:function(a){return Faye.Grammar.CHANNEL_NAME.test(a)||Faye.Grammar.CHANNEL_PATTERN.test(a)},parse:function(a){if(!this.isValid(a))return null;return a.split('/').slice(1)},isMeta:function(a){var c=this.parse(a);return c?(c[0]===this.META):null},isService:function(a){var c=this.parse(a);return c?(c[0]===this.SERVICE):null},isSubscribable:function(a){if(!this.isValid(a))return null;return!this.isMeta(a)&&!this.isService(a)},Tree:Faye.Class({initialize:function(a){this._2=a;this._5={}},eachChild:function(b,d){Faye.each(this._5,function(a,c){b.call(d,a,c)})},each:function(b,d,f){this.eachChild(function(a,c){a=b.concat(a);c.each(a,d,f)});if(this._2!==undefined)d.call(f,b,this._2)},map:function(b,d){var f=[];this.each([],function(a,c){f.push(b.call(d,a,c))});return f},get:function(a){var c=this.traverse(a);return c?c._2:null},set:function(a,c){var b=this.traverse(a,true);if(b)b._2=c},traverse:function(a,c){if(typeof a==='string')a=Faye.Channel.parse(a);if(a===null)return null;if(a.length===0)return this;var b=this._5[a[0]];if(!b&&!c)return null;if(!b)b=this._5[a[0]]=new Faye.Channel.Tree();return b.traverse(a.slice(1),c)},findOrCreate:function(a){var c=this.get(a);if(c)return c;c=new Faye.Channel(a);this.set(a,c);return c},glob:function(f){if(typeof f==='string')f=Faye.Channel.parse(f);if(f===null)return[];if(f.length===0)return(this._2===undefined)?[]:[this._2];var g=[];if(Faye.enumEqual(f,['*'])){Faye.each(this._5,function(a,c){if(c._2!==undefined)g.push(c._2)});return g}if(Faye.enumEqual(f,['**'])){g=this.map(function(a,c){return c});if(this._2!==undefined)g.pop();return g}Faye.each(this._5,function(c,b){if(c!==f[0]&&c!=='*')return;var d=b.glob(f.slice(1));Faye.each(d,function(a){g.push(a)})});if(this._5['**'])g.push(this._5['**']._2);return g}})});Faye.Namespace=Faye.Class({initialize:function(){this._m={}},generate:function(){var a=Faye.random();while(this._m.hasOwnProperty(a))a=Faye.random();return this._m[a]=a}});Faye.Transport=Faye.extend(Faye.Class({initialize:function(a,c){this._f=a;this._6=c},send:function(b,d,f){if(!(b instanceof Array)&&!b.id)b.id=this._f._n.generate();this.request(b,function(c){if(!d)return;Faye.each([].concat(c),function(a){if(a.id===b.id)d.call(f,a);if(a.advice)this._f._r(a.advice);if(a.data&&a.channel)this._f._s(a)},this)},this)}}),{get:function(b,d){var f=b._6;if(d===undefined)d=this.supportedConnectionTypes();var g=null;Faye.each(this._g,function(a,c){if(Faye.indexOf(d,a)<0)return;if(g)return;if(c.isUsable(f))g=c});if(!g)throw'Could not find a usable connection type for '+f;return new g(b,f)},register:function(a,c){this._g[a]=c;c.prototype.connectionType=a},_g:{},supportedConnectionTypes:function(){var b=[],d;Faye.each(this._g,function(a,c){b.push(a)});return b}});Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:'handshake',RETRY:'retry',NONE:'none',DEFAULT_ENDPOINT:'/bayeux',MAX_DELAY:0.1,INTERVAL:1000.0,initialize:function(a){this._6=a||this.DEFAULT_ENDPOINT;this._4=Faye.Transport.get(this);this._0=this.UNCONNECTED;this._n=new Faye.Namespace();this._h=[];this._a=new Faye.Channel.Tree();this._9=[];this._7={reconnect:this.RETRY,interval:this.INTERVAL};if(!Faye.Event)return;Faye.Event.on(Faye.ENV,'beforeunload',this.disconnect,this)},handshake:function(c,b){if(this._7.reconnect===this.NONE)return;if(this._0!==this.UNCONNECTED)return;this._0=this.CONNECTING;var d=this;this._4.send({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:Faye.Transport.supportedConnectionTypes()},function(a){if(!a.successful){setTimeout(function(){d.handshake(c,b)},this._7.interval);return this._0=this.UNCONNECTED}this._0=this.CONNECTED;this._8=a.clientId;this._4=Faye.Transport.get(this,a.supportedConnectionTypes);if(c)c.call(b)},this)},connect:function(c,b){if(this._7.reconnect===this.NONE)return;if(this._7.reconnect===this.HANDSHAKE||this._0===this.UNCONNECTED)return this.handshake(function(){this.connect(c,b)},this);if(this._0===this.CONNECTING)return this._9.push([c,b]);if(this._0!==this.CONNECTED)return;if(c)c.call(b);Faye.each(this._9,function(a){a[0].call(a[1])});this._9=[];if(this._i)return;this._i=this._n.generate();var d=this;this._4.send({channel:Faye.Channel.CONNECT,clientId:this._8,connectionType:this._4.connectionType,id:this._i},function(a){delete this._i;setTimeout(function(){d.connect()},this._7.interval)},this)},disconnect:function(){if(this._0!==this.CONNECTED)return;this._0=this.DISCONNECTED;this._4.send({channel:Faye.Channel.DISCONNECT,clientId:this._8});this._a=new Faye.Channel.Tree()},subscribe:function(b,d,f){if(this._0!==this.CONNECTED)return;b=[].concat(b);this._j(b);this._4.send({channel:Faye.Channel.SUBSCRIBE,clientId:this._8,subscription:b},function(c){if(!c.successful)return;b=[].concat(c.subscription);Faye.each(b,function(a){this._a.set(a,[d,f])},this)},this)},unsubscribe:function(b,d,f){if(this._0!==this.CONNECTED)return;b=[].concat(b);this._j(b);this._4.send({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._8,subscription:b},function(c){if(!c.successful)return;b=[].concat(c.subscription);Faye.each(b,function(a){this._a.set(a,null)},this)},this)},publish:function(a,c){if(this._0!==this.CONNECTED)return;this._j([a]);this._t({channel:a,data:c,clientId:this._8});if(this._o)return;var b=this;this._o=setTimeout(function(){delete b._o;b._u()},this.MAX_DELAY*1000)},_t:function(a){this._h.push(a)},_u:function(){this._4.send(this._h);this._h=[]},_j:function(c){Faye.each(c,function(a){if(!Faye.Channel.isValid(a))throw'"'+a+'" is not a valid channel name';if(!Faye.Channel.isSubscribable(a))throw'Clients may not subscribe to channel "'+a+'"';})},_r:function(a){Faye.extend(this._7,a);if(this._7.reconnect===this.HANDSHAKE)this._8=null},_s:function(c){var b=this._a.glob(c.channel);Faye.each(b,function(a){if(!a)return;a[0].call(a[1],c.data)})}});Faye.Event={_b:[],on:function(a,c,b,d){var f=function(){b.call(d)};if(a.addEventListener)a.addEventListener(c,f,false);else a.attachEvent('on'+c,f);this._b.push({_c:a,_k:c,_v:b,_d:d,_p:f})},detach:function(a,c,b,d){var f=this._b.length,g;while(f--){g=this._b[f];if((a&&a!==g._c)||(c&&c!==g._k)||(b&&b!==g._v)||(d&&d!==g._d))continue;if(g._c.removeEventListener)g._c.removeEventListener(g._k,g._p,false);else g._c.detachEvent('on'+g._k,g._p);this._b.splice(f,1);g=null}}};Faye.Event.on(Faye.ENV,'unload',Faye.Event.detach,Faye.Event);Faye.URI=Faye.extend(Faye.Class({queryString:function(){var b=[],d;Faye.each(this.params,function(a,c){b.push(encodeURIComponent(a)+'='+encodeURIComponent(c))});return b.join('&')},isLocal:function(){var a=Faye.URI.parse(Faye.ENV.location.href);var c=(a.hostname!==this.hostname)||(a.port!==this.port)||(a.protocol!==this.protocol);return!c},toURL:function(){return this.protocol+this.hostname+':'+this.port+this.pathname+'?'+this.queryString()}}),{parse:function(d,f){if(typeof d!=='string')return d;var g=new this();var k=function(c,b){d=d.replace(b,function(a){if(a)g[c]=a;return''})};k('protocol',/^https?\:\/+/);k('hostname',/^[^\/\:]+/);k('port',/^:[0-9]+/);Faye.extend(g,{protocol:'http://',hostname:Faye.ENV.location.hostname,port:Faye.ENV.location.port},false);if(!g.port)g.port=(g.protocol==='https://')?'443':'80';g.port=g.port.replace(/\D/g,'');var i=d.split('?'),h=i.shift(),l=i.join('?'),n=l?l.split('&'):[],o=n.length,j={};while(o--){i=n[o].split('=');j[decodeURIComponent(i[0]||'')]=decodeURIComponent(i[1]||'')}Faye.extend(j,f);g.pathname=h;g.params=j;return g}});Faye.XHR={request:function(a,c,b,d,f){var g=new this.Request(a,c,b,d,f);g.send();return g},getXhrObject:function(){return Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},Request:Faye.Class({initialize:function(a,c,b,d,f){this._e=a.toUpperCase();this._6=Faye.URI.parse(c,b);this._9=(typeof d==='function')?{success:d}:d;this._d=f||null;this._3=null},send:function(){if(this._l)return;var a=this._6.pathname,c=this._6.queryString();if(this._e==='GET')a+='?'+c;var b=this._e==='POST'?c:'';this._l=true;this._3=Faye.XHR.getXhrObject();this._3.open(this._e,a,true);if(this._e==='POST')this._3.setRequestHeader('Content-Type','application/x-www-form-urlencoded');var d=this,f=function(){if(d._3.readyState!==4)return;if(g){clearInterval(g);g=null}Faye.Event.detach(Faye.ENV,'beforeunload',d.abort,d);d._l=false;d._w();d=null};var g=setInterval(f,10);Faye.Event.on(Faye.ENV,'beforeunload',this.abort,this);this._3.send(b)},abort:function(){this._3.abort()},_w:function(){var a=this._9;if(!a)return;return this.success()?a.success&&a.success.call(this._d,this):a.failure&&a.failure.call(this._d,this)},waiting:function(){return!!this._l},complete:function(){return this._3&&!this.waiting()},success:function(){if(!this.complete())return false;var a=this._3.status;return(a>=200&&a<300)||a===304||a===1223},failure:function(){if(!this.complete())return false;return!this.success()},text:function(){if(!this.complete())return null;return this._3.responseText},status:function(){if(!this.complete())return null;return this._3.status}})};if(!this.JSON){JSON={}}(function(){function l(a){return a<10?'0'+a:a}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(a){return this.getUTCFullYear()+'-'+l(this.getUTCMonth()+1)+'-'+l(this.getUTCDate())+'T'+l(this.getUTCHours())+':'+l(this.getUTCMinutes())+':'+l(this.getUTCSeconds())+'Z'};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()}}var n=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,p,s={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},m;function r(b){o.lastIndex=0;return o.test(b)?'"'+b.replace(o,function(a){var c=s[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function q(a,c){var b,d,f,g,k=j,i,h=c[a];if(h&&typeof h==='object'&&typeof h.toJSON==='function'){h=h.toJSON(a)}if(typeof m==='function'){h=m.call(c,a,h)}switch(typeof h){case'string':return r(h);case'number':return isFinite(h)?String(h):'null';case'boolean':case'null':return String(h);case'object':if(!h){return'null'}j+=p;i=[];if(Object.prototype.toString.apply(h)==='[object Array]'){g=h.length;for(b=0;b<g;b+=1){i[b]=q(b,h)||'null'}f=i.length===0?'[]':j?'[\n'+j+i.join(',\n'+j)+'\n'+k+']':'['+i.join(',')+']';j=k;return f}if(m&&typeof m==='object'){g=m.length;for(b=0;b<g;b+=1){d=m[b];if(typeof d==='string'){f=q(d,h);if(f){i.push(r(d)+(j?': ':':')+f)}}}}else{for(d in h){if(Object.hasOwnProperty.call(h,d)){f=q(d,h);if(f){i.push(r(d)+(j?': ':':')+f)}}}}f=i.length===0?'{}':j?'{\n'+j+i.join(',\n'+j)+'\n'+k+'}':'{'+i.join(',')+'}';j=k;return f}}if(typeof JSON.stringify!=='function'){JSON.stringify=function(a,c,b){var d;j='';p='';if(typeof b==='number'){for(d=0;d<b;d+=1){p+=' '}}else if(typeof b==='string'){p=b}m=c;if(c&&typeof c!=='function'&&(typeof c!=='object'||typeof c.length!=='number')){throw new Error('JSON.stringify');}return q('',{'':a})}}if(typeof JSON.parse!=='function'){JSON.parse=function(g,k){var i;function h(a,c){var b,d,f=a[c];if(f&&typeof f==='object'){for(b in f){if(Object.hasOwnProperty.call(f,b)){d=h(f,b);if(d!==undefined){f[b]=d}else{delete f[b]}}}}return k.call(a,c,f)}n.lastIndex=0;if(n.test(g)){g=g.replace(n,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(g.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){i=eval('('+g+')');return typeof k==='function'?h({'':i},''):i}throw new SyntaxError('JSON.parse');}}}());Faye.XHRTransport=Faye.Class(Faye.Transport,{request:function(c,b,d){var f={message:JSON.stringify(c)};Faye.XHR.request('post',this._6,f,function(a){if(b)b.call(d,JSON.parse(a.text()))})}});Faye.XHRTransport.isUsable=function(a){return Faye.URI.parse(a).isLocal()};Faye.Transport.register('long-polling',Faye.XHRTransport);Faye.JSONPTransport=Faye.extend(Faye.Class(Faye.Transport,{request:function(c,b,d){var f={message:JSON.stringify(c)},g=document.getElementsByTagName('head')[0],k=document.createElement('script'),i=Faye.JSONPTransport.getCallbackName(),h=Faye.URI.parse(this._6,f);Faye.ENV[i]=function(a){Faye.ENV[i]=undefined;try{delete Faye.ENV[i]}catch(e){}g.removeChild(k);if(b)b.call(d,a)};h.params.jsonp=i;k.type='text/javascript';k.src=h.toURL();g.appendChild(k)}}),{_q:0,getCallbackName:function(){this._q+=1;return'__jsonp'+this._q+'__'}});Faye.JSONPTransport.isUsable=function(a){return true};Faye.Transport.register('callback-polling',Faye.JSONPTransport);